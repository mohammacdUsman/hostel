<%- include('partials/header_sidebar') %>

<style>
    /* Back Button */
    .btn-back-premium {
        display: inline-flex; align-items: center; padding: 10px 25px;
        background: #ffffff; color: #1a1a1a; border-radius: 50px;
        text-decoration: none; font-family: 'Poppins', sans-serif; font-weight: 600;
        border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }
    .btn-back-premium:hover {
        background: #fff; color: #D4AF37; border-color: #D4AF37;
        box-shadow: 0 8px 25px rgba(212, 175, 55, 0.2); transform: translateX(-5px);
    }
</style>

<div class="content-wrapper">
    
    <!-- BACK BUTTON -->
    <div class="container mt-4 mb-3">
        <a href="/" class="btn-back-premium"><i class="bi bi-arrow-left"></i> Home</a>
    </div>

    <div class="row">
        <!-- LEFT COLUMN -->
        <div class="col-lg-8">
            <!-- Slider -->
            <div id="hostelCarousel" class="carousel slide mb-4 shadow-sm rounded overflow-hidden" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    <% images.forEach((img, index) => { %>
                        <button type="button" data-bs-target="#hostelCarousel" data-bs-slide-to="<%= index %>" class="<%= index === 0 ? 'active' : '' %>"></button>
                    <% }); %>
                </div>
                <div class="carousel-inner">
                    <% if(images.length > 0) { %>
                        <% images.forEach((img, index) => { %>
                            <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                <img src="/uploads/<%= img.image_path %>" class="d-block w-100" style="height: 450px; object-fit: cover;">
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="carousel-item active">
                            <img src="<%= hostel.image ? '/uploads/'+hostel.image : 'https://via.placeholder.com/800x400' %>" class="d-block w-100" style="height: 450px; object-fit: cover;">
                        </div>
                    <% } %>
                </div>
                <% if(images.length > 1) { %>
                    <button class="carousel-control-prev" type="button" data-bs-target="#hostelCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
                    <button class="carousel-control-next" type="button" data-bs-target="#hostelCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
                <% } %>
            </div>

            <!-- Info Card -->
            <div class="card border-0 shadow-sm p-4 mb-4">
                <h2 class="fw-bold mb-0" style="font-family: 'Cinzel';"><%= hostel.name %></h2>
                <p class="text-muted mt-1 mb-3">
                    <i class="bi bi-geo-alt-fill text-danger"></i> <%= hostel.area %> | 
                    <span class="badge bg-dark"><%= hostel.category %></span>
                </p>

                <div class="mb-3">
                    <% if (hostel.facilities) { %>
                        <% hostel.facilities.split(',').forEach(f => { %>
                            <span class="badge bg-success bg-opacity-75 me-1 mb-1"><i class="bi bi-check-circle-fill"></i> <%= f.trim() %></span>
                        <% }); %>
                    <% } %>
                </div>

                <hr>
                <h5 class="fw-bold">Description</h5>
                <p class="text-secondary" style="white-space: pre-line;"><%= hostel.description %></p>

                <!-- Map Section -->
                <% if(hostel.map_embed) { %>
                    <div class="mt-4">
                        <h5 class="fw-bold"><i class="bi bi-map"></i> Location</h5>
                        <div class="ratio ratio-21x9 border rounded shadow-sm"><%- hostel.map_embed %></div>
                    </div>
                <% } %>
            </div>
            
            <!-- Reviews -->
            <div class="card border-0 shadow-sm p-4 mb-4">
                <h4 class="fw-bold mb-3"><i class="bi bi-star-fill text-warning"></i> Reviews</h4>
                <div class="d-flex align-items-center mb-4 bg-light p-3 rounded">
                    <h1 class="fw-bold mb-0 me-3 display-4"><%= rating && rating.avg ? Number(rating.avg).toFixed(1) : '0.0' %></h1>
                    <div>
                        <div class="text-warning">
                            <% for(let i=1; i<=5; i++) { %>
                                <i class="bi <%= (rating && i <= rating.avg) ? 'bi-star-fill' : 'bi-star' %>"></i>
                            <% } %>
                        </div>
                        <small class="text-muted"><%= rating && rating.count ? rating.count : 0 %> Reviews</small>
                    </div>
                </div>
                
                <!-- Reviews List -->
                <div class="review-list mb-4" style="max-height: 300px; overflow-y: auto;">
                    <% if (reviews.length > 0) { %>
                        <% reviews.forEach(r => { %>
                            <div class="d-flex mb-3 border-bottom pb-2">
                                <img src="<%= r.profile_pic ? '/uploads/'+r.profile_pic : 'https://via.placeholder.com/40' %>" class="rounded-circle me-3 shadow-sm" style="width:40px; height:40px; object-fit:cover;">
                                <div>
                                    <h6 class="mb-0 fw-bold"><%= r.name %></h6>
                                    <div class="text-warning small mb-1">
                                        <% for(let i=1; i<=5; i++) { %><i class="bi <%= i <= r.rating ? 'bi-star-fill' : 'bi-star' %>"></i><% } %>
                                    </div>
                                    <p class="text-secondary small mb-0"><%= r.comment %></p>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p class="text-muted small text-center">No reviews yet.</p>
                    <% } %>
                </div>

                <!-- Review Form -->
                <% if(user && user.role === 'student') { %>
                    <form action="/submit_review" method="POST" class="bg-light p-3 rounded">
                        <input type="hidden" name="hostel_id" value="<%= hostel.id %>">
                        <div class="mb-2">
                            <select name="rating" class="form-select w-auto">
                                <option value="5">5 Stars</option>
                                <option value="4">4 Stars</option>
                                <option value="3">3 Stars</option>
                                <option value="2">2 Stars</option>
                                <option value="1">1 Star</option>
                            </select>
                        </div>
                        <textarea name="comment" class="form-control mb-2" placeholder="Write a review..." required></textarea>
                        <button class="btn btn-gold btn-sm w-100">Post Review</button>
                    </form>
                <% } %>
            </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm p-4 mb-4 sticky-top" style="top: 100px;">
                <h3 class="text-success fw-bold text-center mb-3">Rs. <%= hostel.price.toLocaleString() %> <small class="text-muted fs-6">/month</small></h3>
                
                <% if (is_owner) { %>
                    <div class="alert alert-info text-center">You own this hostel</div>
                    <a href="/owner_dashboard" class="btn btn-dark w-100 mb-2">Dashboard</a>
                    <a href="/edit_hostel/<%= hostel.id %>" class="btn btn-outline-dark w-100">Edit Details</a>
                <% } else { %>
                    <% if (user) { %>
                        <a href="/chat/<%= hostel.owner_id %>" class="btn btn-outline-primary w-100 mb-2 fw-bold"><i class="bi bi-chat-dots-fill"></i> Chat with Owner</a>
                        
                        <form action="/book_hostel" method="POST" class="mb-2">
                            <input type="hidden" name="hostel_id" value="<%= hostel.id %>">
                            <button class="btn btn-gold w-100 fw-bold" style="background: #D4AF37; border:none;">Book Now</button>
                        </form>

                        <!-- ✅ FIXED ANNOUNCEMENT BUTTON -->
                        <% if(hostel.announcement_text && hostel.announcement_text.trim() !== "") { %>
                            <button type="button" class="btn btn-warning w-100 shadow-sm fw-bold text-dark" 
                                    onclick="openAnnouncement()">
                                <i class="bi bi-megaphone-fill"></i> View Announcement
                            </button>
                        <% } %>

                    <% } else { %>
                        <a href="/login" class="btn btn-gold w-100 fw-bold">Login to Book</a>
                    <% } %>
                <% } %>

                <!-- Navigation Link -->
                <a href="https://www.google.com/maps/search/?api=1&query=<%= encodeURIComponent(hostel.name + ' ' + hostel.area + ' Faisalabad') %>" target="_blank" class="btn btn-link text-muted mt-2 text-decoration-none text-center d-block small">
                    <i class="bi bi-box-arrow-up-right"></i> Open in Google Maps
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ✅ FIXED ANNOUNCEMENT MODAL (Moved Outside) -->
<div class="modal fade" id="announceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="background: #fff8e1; border-left: 5px solid #D4AF37 !important;">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-dark" style="font-family: 'Cinzel';">
                    <i class="bi bi-bell-fill text-warning"></i> Notice from Owner
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-dark fs-5" style="font-family: 'Poppins';">
                <%= hostel.announcement_text %>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-dark btn-sm rounded-pill" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ FORCE OPEN SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function openAnnouncement() {
        var myModal = new bootstrap.Modal(document.getElementById('announceModal'));
        myModal.show();
    }
</script>

<%- include('partials/footer') %>